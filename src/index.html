<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Texto Avançado</title>
    <!-- Tailwind CSS CDN para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca Lucide Icons para ícones modernos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Variável CSS para a coluna da régua, usada para posicionamento dinâmico */
        :root {
            --ruler-column: 80;
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Impede o scroll no body */
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #editor {
            font-family: 'Roboto Mono', monospace; /* Fonte monoespaçada para consistência */
            resize: none; /* O redimensionamento é controlado pelo layout flex */
        }
        
        /* Estilo da linha da régua */
        #ruler-line {
            position: absolute;
            top: 0;
            bottom: 0;
            /* Calcula a posição baseada na variável CSS e no padding do editor */
            left: calc(var(--ruler-column) * 1ch + 1rem); /* 1rem = p-4 */
            border-left: 1px solid #ef4444; /* Cor vermelha para a régua */
            z-index: 0;
            opacity: 0.6;
            pointer-events: none; /* Impede que a linha intercepte cliques */
        }
        /* Efeito de transição suave para modais */
        .modal-overlay {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
             transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        /* Estilo para a caixa de mensagem flutuante (Toast) */
        #message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .dark #message-box {
             background-color: #e2e8f0;
             color: #1a202c;
        }
        #message-box.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 flex flex-col">

    <div id="main-container" class="w-full h-full flex flex-col bg-white dark:bg-slate-800">

        <!-- Barra de Ferramentas Principal -->
        <div class="toolbar flex flex-wrap items-center justify-between p-3 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 gap-2 flex-shrink-0">
             <!-- Grupo de Documentos -->
            <div class="flex items-center gap-2">
                <button id="new-doc-btn" title="Novo Documento (Ctrl+N)" class="p-2 rounded-md text-slate-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors"><i data-lucide="file-plus-2"></i></button>
                <select id="doc-selector" class="p-2 border border-gray-300 rounded-md bg-white dark:bg-slate-700 dark:border-slate-600 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                <button id="delete-doc-btn" title="Excluir Documento Atual" class="p-2 rounded-md hover:bg-red-200 dark:hover:bg-red-800 transition-colors text-red-600 dark:text-red-400"><i data-lucide="trash-2"></i></button>
            </div>
            
            <!-- Grupo de Ferramentas de Edição -->
            <div class="flex items-center gap-2">
                 <button id="download-btn" title="Baixar como .txt" class="p-2 rounded-md text-slate-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors"><i data-lucide="download"></i></button>
                 <button id="find-replace-btn" title="Localizar e Substituir (Ctrl+F)" class="p-2 rounded-md text-slate-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors"><i data-lucide="search"></i></button>
            </div>

            <!-- Grupo de Configurações e Ajuda -->
            <div class="flex items-center gap-2">
                <div class="ruler-input-group flex items-center gap-2 text-slate-600 dark:text-slate-300">
                    <i data-lucide="ruler" class=""></i>
                    <input type="number" id="ruler-column-input" min="10" max="200" value="80" class="w-16 p-1 border border-gray-300 rounded-md bg-white dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <button id="toggle-mode-btn" title="Alternar Tema" class="p-2 rounded-md text-slate-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors"><i data-lucide="moon"></i></button>
                <button id="show-shortcuts-btn" title="Ver Atalhos" class="p-2 rounded-md text-slate-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors"><i data-lucide="keyboard"></i></button>
            </div>
        </div>

        <!-- Área de Edição de Texto Wrapper -->
        <div id="editor-wrapper" class="relative flex-grow bg-white dark:bg-slate-900">
            <div id="ruler-line"></div>
            <textarea id="editor" class="w-full h-full p-4 text-base focus:outline-none z-10 bg-transparent text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500" placeholder="Carregando..."></textarea>
        </div>

        <!-- Barra de Status -->
        <div class="status-bar flex justify-end items-center p-2 border-t border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 text-sm text-gray-600 dark:text-gray-400 gap-4 flex-shrink-0">
            <span id="save-status"></span>
            <span id="word-count">Palavras: 0</span>
            <span id="char-count">Caracteres: 0</span>
            <span id="user-id-display" class="font-mono text-xs" title="Seu ID de Usuário"></span>
        </div>
    </div>

    <!-- Modais -->
    <div id="shortcuts-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 opacity-0 invisible">
        <div class="modal-content bg-white dark:bg-slate-800 p-8 rounded-lg shadow-xl max-w-lg w-full relative transform -translate-y-5 text-slate-800 dark:text-slate-200">
            <button id="shortcuts-modal-close-btn" class="modal-close-btn absolute top-3 right-3 p-1 rounded-full text-2xl hover:bg-gray-200 dark:hover:bg-slate-700">&times;</button>
            <h2 class="text-2xl font-bold mb-4">Atalhos de Teclado</h2>
            <div class="space-y-2">
                <p><kbd class="font-mono bg-gray-200 dark:bg-slate-600 p-1 rounded">Ctrl + S</kbd>: Forçar salvamento do documento.</p>
                <p><kbd class="font-mono bg-gray-200 dark:bg-slate-600 p-1 rounded">Ctrl + F</kbd>: Abrir Localizar e Substituir.</p>
                <p><kbd class="font-mono bg-gray-200 dark:bg-slate-600 p-1 rounded">Ctrl + N</kbd>: Criar novo documento.</p>
                <p><kbd class="font-mono bg-gray-200 dark:bg-slate-600 p-1 rounded">Ctrl + D</kbd>: Selecionar próxima ocorrência.</p>
                <p><kbd class="font-mono bg-gray-200 dark:bg-slate-600 p-1 rounded">Ctrl + Shift + D</kbd>: Duplicar linha atual.</p>
                <p><kbd class="font-mono bg-gray-200 dark:bg-slate-600 p-1 rounded">Alt + Shift + ↑/↓</kbd>: Mover linha para cima/baixo.</p>
                <p><kbd class="font-mono bg-gray-200 dark:bg-slate-600 p-1 rounded">Ctrl + U</kbd>: Converter seleção para maiúsculas.</p>
            </div>
        </div>
    </div>

    <div id="find-replace-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 opacity-0 invisible">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl max-w-md w-full relative transform -translate-y-5 text-slate-800 dark:text-slate-200">
            <button id="find-replace-modal-close-btn" class="modal-close-btn absolute top-3 right-3 text-2xl p-1 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">&times;</button>
            <h2 class="text-xl font-bold mb-4">Localizar e Substituir</h2>
            <div class="space-y-4">
                <input type="text" id="find-input" placeholder="Localizar..." class="w-full p-2 border rounded-md bg-white dark:bg-slate-700 dark:border-slate-600">
                <input type="text" id="replace-input" placeholder="Substituir por..." class="w-full p-2 border rounded-md bg-white dark:bg-slate-700 dark:border-slate-600">
                <div class="flex justify-end gap-2">
                    <button id="replace-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Substituir</button>
                    <button id="replace-all-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Substituir Tudo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Caixa de Mensagem (Toast) -->
    <div id="message-box" role="alert" aria-live="polite"></div>
    
    <!-- Scripts do Editor 100% Offline com IndexedDB -->
    <script>
/* --- IndexedDB Helper --- */
const DB_NAME = 'editor-codigo-db';
const STORE_NAME = 'documents';
let db = null;

function openDB() {
    return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        const request = indexedDB.open(DB_NAME, 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };
    });
}

function getAllDocs() {
    return openDB().then(db => {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    });
}

function getDoc(id) {
    return openDB().then(db => {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get(id);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    });
}

function saveDoc(doc) {
    return openDB().then(db => {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const req = store.put(doc);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    });
}

function deleteDocById(id) {
    return openDB().then(db => {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const req = store.delete(id);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    });
}

/* --- DOM Elements --- */
const editor = document.getElementById('editor');
const saveStatus = document.getElementById('save-status');
const wordCountEl = document.getElementById('word-count');
const charCountEl = document.getElementById('char-count');
const toggleModeBtn = document.getElementById('toggle-mode-btn');
const rulerColumnInput = document.getElementById('ruler-column-input');
const rulerLine = document.getElementById('ruler-line');
const docSelector = document.getElementById('doc-selector');
const newDocBtn = document.getElementById('new-doc-btn');
const deleteDocBtn = document.getElementById('delete-doc-btn');
const downloadBtn = document.getElementById('download-btn');
const userIdDisplay = document.getElementById('user-id-display');
const messageBox = document.getElementById('message-box');
const showShortcutsBtn = document.getElementById('show-shortcuts-btn');
const findReplaceBtn = document.getElementById('find-replace-btn');
const shortcutsModalOverlay = document.getElementById('shortcuts-modal-overlay');
const findReplaceModalOverlay = document.getElementById('find-replace-modal-overlay');

let currentDocId = null;
let saveTimeout = null;
let isSaving = false;
let editorReady = false;

/* --- Document Management --- */
async function loadDocumentsList() {
    const docs = await getAllDocs();
    docs.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
    docSelector.innerHTML = '';
    if (docs.length === 0) {
        await createNewDocument("Primeiro Documento");
        return;
    }
    docs.forEach(docData => {
        const option = document.createElement('option');
        option.value = docData.id;
        option.textContent = docData.title || `Documento ${docData.id.substring(0, 4)}`;
        docSelector.appendChild(option);
    });
    const lastDocId = localStorage.getItem(`lastDocId`) || docs[0].id;
    if (docs.some(d => d.id === lastDocId)) {
        docSelector.value = lastDocId;
    }
    await switchDocument(docSelector.value);
}

async function switchDocument(docId) {
    if (currentDocId === docId) return;
    currentDocId = docId;
    localStorage.setItem(`lastDocId`, docId);
    editor.value = "Carregando...";
    editor.disabled = true;
    const doc = await getDoc(currentDocId);
    if (doc) {
        editor.value = doc.content || '';
        updateStatusBar();
    } else {
        editor.value = '';
    }
    editor.disabled = false;
}

async function createNewDocument(title = "Novo Documento") {
    const newTitle = prompt("Digite o título do novo documento:", title);
    if (!newTitle) return;
    const newDoc = {
        id: crypto.randomUUID(),
        title: newTitle,
        content: "",
        createdAt: Date.now(),
        updatedAt: Date.now()
    };
    await saveDoc(newDoc);
    showMessage(`Documento "${newTitle}" criado!`);
    await loadDocumentsList();
    docSelector.value = newDoc.id;
    await switchDocument(newDoc.id);
}

async function deleteCurrentDocument() {
    if (!currentDocId) return;
    const docTitle = docSelector.options[docSelector.selectedIndex].text;
    if (confirm(`Tem certeza que deseja excluir o documento "${docTitle}"? Esta ação não pode ser desfeita.`)) {
        await deleteDocById(currentDocId);
        showMessage("Documento excluído.");
        currentDocId = null;
        await loadDocumentsList();
    }
}

function debounceSave() {
    clearTimeout(saveTimeout);
    if (!editorReady || isSaving) return;
    saveStatus.textContent = 'Salvando...';
    saveTimeout = setTimeout(async () => {
        if (!currentDocId) {
            saveStatus.textContent = "Nenhum documento ativo para salvar.";
            return;
        }
        isSaving = true;
        const doc = await getDoc(currentDocId);
        if (doc) {
            doc.content = editor.value;
            doc.updatedAt = Date.now();
            await saveDoc(doc);
            saveStatus.textContent = 'Salvo localmente';
        }
        isSaving = false;
    }, 1500);
}

/* --- Editor Features (mantém igual) --- */
function updateStatusBar() {
    const text = editor.value;
    const chars = text.length;
    const words = text.trim().split(/\s+/).filter(Boolean).length;
    wordCountEl.textContent = `Palavras: ${words}`;
    charCountEl.textContent = `Caracteres: ${chars}`;
}

function downloadAsTxt() {
    const text = editor.value;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    let docTitle = 'documento';
    if (docSelector.selectedIndex !== -1) {
        docTitle = docSelector.options[docSelector.selectedIndex].text.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    }
    a.download = `${docTitle}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* --- UI Management (tema, régua, modais) --- */
function loadTheme() {
    if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
        toggleModeBtn.innerHTML = '<i data-lucide="sun"></i>';
    } else {
        document.documentElement.classList.remove('dark');
        toggleModeBtn.innerHTML = '<i data-lucide="moon"></i>';
    }
}
function toggleTheme() {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    loadTheme();
    lucide.createIcons();
}
function updateRulerPosition() {
    const column = parseInt(rulerColumnInput.value) || 80;
    document.documentElement.style.setProperty('--ruler-column', column);
    localStorage.setItem('rulerColumn', column);
}
function loadRulerPosition() {
    const savedColumn = localStorage.getItem('rulerColumn');
    if (savedColumn) {
        rulerColumnInput.value = savedColumn;
    }
    updateRulerPosition();
}
function showMessage(message, duration = 3000) {
    messageBox.textContent = message;
    messageBox.classList.add('show');
    setTimeout(() => {
        messageBox.classList.remove('show');
    }, duration);
}
function openModal(overlay) { overlay.classList.add('show'); }
function closeModal(overlay) { overlay.classList.remove('show'); }

/* --- Event Listeners --- */
function addEventListeners() {
    editor.addEventListener('input', () => {
        if (editorReady) debounceSave();
        updateStatusBar();
    });
    editor.addEventListener('scroll', () => {
        rulerLine.style.transform = `translateX(-${editor.scrollLeft}px)`;
    });
    editor.addEventListener('keydown', handleKeyboardShortcuts);
    toggleModeBtn.addEventListener('click', toggleTheme);
    rulerColumnInput.addEventListener('input', updateRulerPosition);
    docSelector.addEventListener('change', (e) => switchDocument(e.target.value));
    newDocBtn.addEventListener('click', () => createNewDocument());
    deleteDocBtn.addEventListener('click', deleteCurrentDocument);
    downloadBtn.addEventListener('click', downloadAsTxt);
    showShortcutsBtn.addEventListener('click', () => openModal(shortcutsModalOverlay));
    document.getElementById('shortcuts-modal-close-btn').addEventListener('click', () => closeModal(shortcutsModalOverlay));
    shortcutsModalOverlay.addEventListener('click', (e) => e.target === shortcutsModalOverlay && closeModal(shortcutsModalOverlay));
    findReplaceBtn.addEventListener('click', () => openModal(findReplaceModalOverlay));
    document.getElementById('find-replace-modal-close-btn').addEventListener('click', () => closeModal(findReplaceModalOverlay));
    findReplaceModalOverlay.addEventListener('click', (e) => e.target === findReplaceModalOverlay && closeModal(findReplaceModalOverlay));
    // Localizar e substituir
    const findInput = document.getElementById('find-input');
    const replaceInput = document.getElementById('replace-input');
    document.getElementById('replace-btn').addEventListener('click', () => {
        const findValue = findInput.value;
        const replaceValue = replaceInput.value;
        if (!findValue) return;
        const currentSelection = editor.value.substring(editor.selectionStart, editor.selectionEnd);
        if(currentSelection.toLowerCase() === findValue.toLowerCase()) {
            editor.setRangeText(replaceValue, editor.selectionStart, editor.selectionEnd, 'select');
        } else {
            const nextIndex = editor.value.indexOf(findValue, editor.selectionEnd);
            if (nextIndex !== -1) {
                editor.setSelectionRange(nextIndex, nextIndex + findValue.length);
            } else {
                showMessage("Fim do documento.", 2000);
            }
        }
        editor.focus();
    });
    document.getElementById('replace-all-btn').addEventListener('click', () => {
        const findValue = findInput.value;
        const replaceValue = replaceInput.value;
        if (!findValue) return;
        const originalValue = editor.value;
        const newValue = originalValue.replaceAll(findValue, replaceValue);
        if(originalValue !== newValue){
            editor.value = newValue;
            showMessage("Todas as ocorrências foram substituídas.", 2000);
        } else {
            showMessage("Nenhuma ocorrência encontrada.", 2000);
        }
    });
    document.addEventListener('keydown', handleKeyboardShortcuts);
}
function handleKeyboardShortcuts(e) {
    const isCtrlOrCmd = e.ctrlKey || e.metaKey;
    const key = e.key.toLowerCase();
    if (isCtrlOrCmd && key === 's') {
        e.preventDefault();
        clearTimeout(saveTimeout);
        debounceSave();
        showMessage("Salvando...", 1000);
    } else if (isCtrlOrCmd && key === 'n') {
        e.preventDefault();
        createNewDocument();
    } else if (isCtrlOrCmd && key === 'f') {
        e.preventDefault();
        openModal(findReplaceModalOverlay);
        document.getElementById('find-input').focus();
    }
}

/* --- Inicialização --- */
document.addEventListener('DOMContentLoaded', async () => {
    loadTheme();
    lucide.createIcons();
    loadRulerPosition();
    userIdDisplay.textContent = `Local`;
    editor.placeholder = "Carregando documentos...";
    await loadDocumentsList();
    editorReady = true;
    addEventListeners();
    updateStatusBar();
});
</script>
</body>
</html>
